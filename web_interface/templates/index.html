<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senior Scraper Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            /* Light theme */
            --bg-color: #f5f7fa;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: white;
            --card-border: #e1e5e9;
            --input-bg: white;
            --input-border: #d1d5db;
            --button-primary: #667eea;
            --button-secondary: #6b7280;
            --table-header: #f9fafb;
            --table-border: #e5e7eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            /* Dark theme */
            --bg-color: #111827;
            --text-color: #f9fafb;
            --header-bg: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --card-bg: #1f2937;
            --card-border: #374151;
            --input-bg: #374151;
            --input-border: #4b5563;
            --button-primary: #3b82f6;
            --button-secondary: #6b7280;
            --table-header: #111827;
            --table-border: #374151;
            --success-color: #34d399;
            --warning-color: #fbbf24;
            --error-color: #f87171;
            --shadow: rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--header-bg);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px var(--shadow);
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        .version-badge {
            position: absolute;
            top: 1rem;
            right: 5rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.35);
            padding: 0.35rem 0.65rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.2px;
            backdrop-filter: blur(4px);

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.35);
            padding: 0.35rem;
            border-radius: 999px;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .theme-toggle svg {
            width: 1.25rem;
            height: 1.25rem;
            color: white;
        }

        .theme-toggle .moon-icon {
            display: none;
        }

        [data-theme="dark"] .theme-toggle .sun-icon {
            display: none;
        }

        [data-theme="dark"] .theme-toggle .moon-icon {
            display: block;
        }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 0.5rem 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-connected {
            background: var(--success-color);
            color: var(--text-color);
            opacity: 0.9;
        }

        .status-disconnected {
            background: var(--error-color);
            color: white;
        }

        .status-running {
            background: var(--warning-color);
            color: var(--text-color);
        }

        .button {
            background: var(--button-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
            margin-top: 1rem;
        }

        .button:hover:not(:disabled) {
            background: var(--button-primary);
            opacity: 0.8;
        }

        .button:disabled {
            background: var(--button-secondary);
            cursor: not-allowed;
        }

        .button-secondary {
            background: #6c757d;
        }

        .button-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .button-danger {
            background: #dc3545;
        }

        .button-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            text-align: left;
            padding: 0.75rem;
            border-bottom: 1px solid var(--table-border);
        }

        .table th {
            background: var(--table-header);
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.8;
        }

        .table tr:hover {
            background: var(--table-header);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #eee;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Senior Scraper Dashboard üë¥üëµ</h1>
        <p>A place for seniors - Manage WordPress imports and community operations</p>
        <div id="version-badge" class="version-badge">Version: ‚Ä¶</div>
        <button id="theme-toggle" class="theme-toggle" title="Toggle Dark Mode">
            <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
            </svg>
            <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
            </svg>
        </button>
    </div>

    <div class="container">
        <!-- Status Cards -->
        <div class="grid">
            <div class="card">
                <h2>üìä WordPress Status</h2>
                <div id="wp-status">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üîê Environment</h2>
                <div id="env-status">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìÖ Last Run</h2>
                <div id="last-run">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('scraper')">üîç Find Communities üë¥</button>
                <button class="tab" onclick="switchTab('single')">üìå Single Listing</button>
                <button class="tab" onclick="switchTab('compare')">üîç Compare Listing</button>
                <button class="tab" onclick="switchTab('import')">üì• Add Communities üëµ</button>
                <button class="tab" onclick="switchTab('history')">üìú Search History</button>
                <button class="tab" onclick="switchTab('test')">üß™ Check System</button>
            </div>

            <!-- Single Listing Tab -->
            <div id="tab-single" class="tab-content">
                <h2>üìå Import Single Listing from Senior Place</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">
                    Quickly fetch and preview a single community by URL, then add to WordPress.
                </p>

                <div class="form-group">
                    <label>Senior Place Listing URL:</label>
                    <input type="text" class="form-control" id="single-url" placeholder="https://app.seniorplace.com/communities/show/..." style="font-family: monospace; font-size: 0.9rem;">
                    <small style="display: block; margin-top: 0.5rem; color: #999;">
                        Example: https://app.seniorplace.com/communities/show/6abadb36-0cff-4931-a9ca-154f27c5795e
                    </small>
                </div>

                <button class="button" id="btn-fetch-single" onclick="fetchSingleListing()">
                    üîó Fetch Listing
                </button>

                <div id="single-status" style="margin-top: 1rem;"></div>
                <div id="single-preview" style="margin-top: 1rem;"></div>
            </div>

            <!-- Compare Single Listing Tab -->
            <div id="tab-compare" class="tab-content">
                <h2>üîç Compare Single Listing with WordPress</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">
                    Fetch a Senior Place listing and compare it with cached WordPress listings to see if it's new, updated, or already exists.
                </p>

                <div class="form-group">
                    <label>Senior Place Listing URL:</label>
                    <input type="text" class="form-control" id="compare-url" placeholder="https://app.seniorplace.com/communities/show/..." style="font-family: monospace; font-size: 0.9rem;">
                    <small style="display: block; margin-top: 0.5rem; color: #999;">
                        Example: https://app.seniorplace.com/communities/show/6b552075-435a-45f2-8017-9d1508054958
                    </small>
                </div>

                <button class="button" id="btn-compare" onclick="compareSingleListing()">
                    üîç Compare with WordPress
                </button>

                <div id="compare-status" style="margin-top: 1rem;"></div>
                <div id="compare-result" style="margin-top: 1rem;"></div>
            </div>

            <!-- Scraper Tab -->
            <div id="tab-scraper" class="tab-content active">
                <h2>üîç Find Senior Communities</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">
                    Discover new senior living communities from Senior Place and keep our directory current.
                </p>
                
                <div class="form-group">
                    <label>Select States to Search:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="state" value="AZ" checked> Arizona
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="state" value="CA" checked> California
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="state" value="CO" checked> Colorado
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="state" value="ID" checked> Idaho
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="state" value="NM" checked> New Mexico
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="state" value="UT" checked> Utah
                        </label>
                    </div>
                </div>

                <button class="button" id="btn-run-scraper" onclick="runScraper()">
                    üöÄ Search for Communities
                </button>

                <div id="scraper-status" style="margin-top: 1rem;"></div>
                <div id="scraper-log" style="margin-top: 1rem;"></div>
            </div>

            <!-- Import Tab -->
            <div id="tab-import" class="tab-content">
                <h2>üì• Add Communities</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">
                    Import senior communities into our WordPress directory to help families find the right place.
                </p>

                <!-- Option 1: Upload CSV -->
                <div class="form-group" style="background: #f0f7ff; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; color: #667eea;">üì§ Upload a CSV File:</label>
                    <input type="file" class="form-control" id="import-csv-upload" accept=".csv" style="margin-top: 0.5rem; padding: 0.5rem;">
                    <small style="display: block; margin-top: 0.5rem; color: #666;">
                        Upload any CSV with columns: title, address, city, state, zip, url (Senior Place URL)
                    </small>
                </div>

                <div style="text-align: center; color: #999; margin: 1rem 0;">‚Äî OR ‚Äî</div>

                <!-- Option 2: Select existing file -->
                <div class="form-group">
                    <label>Select from Existing Files:</label>
                    <select class="form-control" id="import-csv-file">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #eee;">

                <div class="form-group">
                    <label>Batch Size:</label>
                    <input type="number" class="form-control" id="import-batch-size" value="25" min="1" max="100">
                </div>

                <div class="form-group">
                    <label>Limit (optional, leave blank for all):</label>
                    <input type="number" class="form-control" id="import-limit" placeholder="Leave blank for all">
                </div>

                <button class="button" id="btn-run-import" onclick="runImport()">
                    üì• Add Communities
                </button>

                <div id="import-status" style="margin-top: 1rem;"></div>
                <div id="import-log" style="margin-top: 1rem;"></div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content">
                <h2>üìú Search History</h2>
                <div id="history-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading history...</p>
                    </div>
                </div>
            </div>

            <!-- Test Tab -->
            <div id="tab-test" class="tab-content">
                <h2>üß™ Test System Connection</h2>
                <p style="margin-bottom: 1.5rem; color: #666;">
                    Tests WordPress API, Senior Place login, and all dependencies for the senior living database.
                </p>
                
                <button class="button" id="btn-test" onclick="runTest()">
                    üß™ Run Tests
                </button>

                <div id="test-output" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <script>
        let statusRefreshInterval = null;

        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;

        // Load saved theme preference
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // WebSocket for real-time progress updates
        const socket = io();
        let currentPhase = null;

        socket.on('connect', () => {
            console.log('Connected to progress updates');
            socket.emit('start_progress_monitoring');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from progress updates');
        });

        socket.on('wordpress_loaded', (data) => {
            updateProgressDisplay('Loading WordPress data...', 10);
            showProgressMessage(`üìä Loaded ${data.wp_listings_count} existing WordPress listings`);
        });

        socket.on('state_scraped', (data) => {
            const progress = data.percentage;
            updateProgressDisplay(`Scraping ${data.state_name}... (${data.states_completed}/${data.states_total})`, progress);
            showProgressMessage(`‚úÖ ${data.state}: ${data.listings_found} listings found`);
        });

        socket.on('enrichment_started', (data) => {
            updateProgressDisplay('Enriching listings with details...', 60);
            showProgressMessage(`üîÑ Starting enrichment of ${data.total_to_enrich} listings`);
        });

        socket.on('enrichment_completed', (data) => {
            updateProgressDisplay('Enrichment complete, analyzing changes...', 80);
            showProgressMessage(`‚úÖ Enriched ${data.total_enriched}/${data.total_listings} listings`);
        });

        socket.on('comparison_completed', (data) => {
            updateProgressDisplay('Generating import files...', 90);
            showProgressMessage(`üìã Found ${data.new_listings} new, ${data.updated_listings} updated listings`);
        });

        socket.on('files_generated', (data) => {
            updateProgressDisplay('Update complete!', 100);
            showProgressMessage(`üìÅ Import files generated in: ${data.output_dir}`);
        });

        socket.on('update_complete', (data) => {
            updateProgressDisplay('‚úÖ Update Complete!', 100);
            showProgressMessage(`üéâ Process finished! Stats: ${JSON.stringify(data.stats, null, 2)}`);
            setTimeout(() => hideProgressDisplay(), 5000); // Hide after 5 seconds
        });

        socket.on('error', (data) => {
            showProgressMessage(`‚ùå Error in ${data.phase}: ${data.error}`, 'error');
        });

        function updateProgressDisplay(message, percentage) {
            let progressContainer = document.getElementById('progress-container');
            if (!progressContainer) {
                progressContainer = document.createElement('div');
                progressContainer.id = 'progress-container';
                progressContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--card-bg);
                    border: 2px solid var(--button-primary);
                    border-radius: 8px;
                    padding: 15px;
                    box-shadow: 0 4px 12px var(--shadow);
                    z-index: 1000;
                    min-width: 300px;
                `;

                progressContainer.innerHTML = `
                    <div style="margin-bottom: 10px; font-weight: bold;">üîÑ Real-time Progress</div>
                    <div id="progress-message" style="margin-bottom: 10px; font-size: 14px;">${message}</div>
                    <div style="background: var(--card-border); border-radius: 4px; height: 8px; overflow: hidden;">
                        <div id="progress-bar" style="background: var(--button-primary); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="progress-percentage" style="text-align: center; margin-top: 5px; font-size: 12px; color: var(--text-color); opacity: 0.7;">${percentage}%</div>
                    <div id="progress-details" style="margin-top: 10px; font-size: 12px; max-height: 100px; overflow-y: auto;"></div>
                `;

                document.body.appendChild(progressContainer);
            } else {
                document.getElementById('progress-message').textContent = message;
                document.getElementById('progress-bar').style.width = percentage + '%';
                document.getElementById('progress-percentage').textContent = percentage + '%';
            }
        }

        function showProgressMessage(message, type = 'info') {
            const detailsDiv = document.getElementById('progress-details');
            if (detailsDiv) {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    padding: 3px 0;
                    font-size: 11px;
                    border-bottom: 1px solid var(--card-border);
                    color: ${type === 'error' ? 'var(--error-color)' : 'var(--text-color)'};
                    opacity: 0.8;
                `;
                const timestamp = new Date().toLocaleTimeString();
                messageDiv.textContent = `[${timestamp}] ${message}`;
                detailsDiv.appendChild(messageDiv);
                detailsDiv.scrollTop = detailsDiv.scrollHeight;
            }
        }

        function hideProgressDisplay() {
            const progressContainer = document.getElementById('progress-container');
            if (progressContainer) {
                progressContainer.remove();
            }
        }

        // Load initial status
        loadStatus();

        // Refresh status every 10 seconds
        statusRefreshInterval = setInterval(loadStatus, 10000);

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Update WordPress status
                const wpStatus = document.getElementById('wp-status');
                if (data.wordpress.error) {
                    wpStatus.innerHTML = `
                        <span class="status-badge status-disconnected">Disconnected</span>
                        <p style="margin-top: 0.5rem; color: #666;">${data.wordpress.error}</p>
                    `;
                } else {
                    wpStatus.innerHTML = `
                        <span class="status-badge status-connected">Connected</span>
                        <div class="stat-number">${data.wordpress.total_listings.toLocaleString()}</div>
                        <div class="stat-label">Total Listings</div>
                    `;
                }

                // Update version badge
                const versionBadge = document.getElementById('version-badge');
                if (versionBadge) {
                    const ver = data.app_version || 'unknown';
                    versionBadge.textContent = `Version: ${ver}`;
                }

                // Update environment status
                const envStatus = document.getElementById('env-status');
                envStatus.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <strong>WordPress:</strong> 
                            <span class="status-badge ${data.environment.wp_credentials ? 'status-connected' : 'status-disconnected'}">
                                ${data.environment.wp_credentials ? 'Configured' : 'Missing'}
                            </span>
                        </div>
                        <div>
                            <strong>Senior Place:</strong> 
                            <span class="status-badge ${data.environment.sp_credentials ? 'status-connected' : 'status-disconnected'}">
                                ${data.environment.sp_credentials ? 'Configured' : 'Missing'}
                            </span>
                        </div>
                    </div>
                `;

                // Update last run
                const lastRun = document.getElementById('last-run');
                if (data.recent_runs && data.recent_runs.length > 0) {
                    const run = data.recent_runs[0];
                    lastRun.innerHTML = `
                        <div class="stat-label">${formatTimestamp(run.timestamp)}</div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 1rem;">
                            <div>
                                <div style="font-weight: 600; color: #28a745;">${run.stats.new_listings_found}</div>
                                <div class="stat-label">New</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #667eea;">${run.stats.listings_updated}</div>
                                <div class="stat-label">Updated</div>
                            </div>
                        </div>
                    `;
                } else {
                    lastRun.innerHTML = '<p style="color: #666;">No runs yet</p>';
                }

                // Update CSV file dropdown
                const csvSelect = document.getElementById('import-csv-file');
                if (data.csv_files && data.csv_files.length > 0) {
                    csvSelect.innerHTML = '<option value="">Select a file...</option>' + 
                        data.csv_files.map(file => 
                            `<option value="${file.path}">${file.name} (${file.modified})</option>`
                        ).join('');
                } else {
                    csvSelect.innerHTML = '<option value="">No CSV files found</option>';
                }

                // Update history table
                updateHistoryTable(data.recent_runs);

            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        function updateHistoryTable(runs) {
            const historyContent = document.getElementById('history-content');
            
            if (!runs || runs.length === 0) {
                historyContent.innerHTML = '<p style="color: #666;">No runs found</p>';
                return;
            }

            historyContent.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>üè° New Communities</th>
                            <th>üîÑ Updated</th>
                            <th>üè• Care Type Updates</th>
                            <th>üí∞ Pricing Updates</th>
                            <th>‚ùå Failed</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${runs.map(run => `
                            <tr>
                                <td>${formatTimestamp(run.timestamp)}</td>
                                <td>${run.stats.new_listings_found}</td>
                                <td>${run.stats.listings_updated}</td>
                                <td>${run.stats.care_type_updates}</td>
                                <td>${run.stats.pricing_updates}</td>
                                <td style="color: ${run.stats.failed_scrapes > 0 ? '#dc3545' : '#666'}">
                                    ${run.stats.failed_scrapes}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function compareSingleListing() {
            const button = document.getElementById('btn-compare');
            const statusDiv = document.getElementById('compare-status');
            const resultDiv = document.getElementById('compare-result');
            const url = document.getElementById('compare-url').value.trim();
            
            if (!url) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Please enter a Senior Place URL</div>';
                return;
            }
            
            if (!url.includes('seniorplace.com') || !url.includes('/show/')) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Invalid URL. Must be a Senior Place community URL (contains /show/)</div>';
                return;
            }
            
            button.disabled = true;
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Fetching and comparing listing...</p></div>';
            resultDiv.innerHTML = '';
            
            try {
                const response = await fetch('/api/compare-single-listing', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const spListing = data.sp_listing;
                    const matchType = data.match_type;
                    const wpListing = data.wp_listing;
                    const message = data.message;
                    
                    let statusClass = 'alert-info';
                    let statusIcon = '‚ÑπÔ∏è';
                    if (matchType === 'new') {
                        statusClass = 'alert-success';
                        statusIcon = 'üÜï';
                    } else if (matchType === 'exists' || matchType === 'exists_by_title') {
                        statusClass = 'alert-warning';
                        statusIcon = '‚ö†Ô∏è';
                    }
                    
                    statusDiv.innerHTML = `<div class="alert ${statusClass}">${statusIcon} ${message}</div>`;
                    
                    // Build comparison display
                    let comparisonHtml = `
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                            <h3 style="margin-bottom: 1rem;">Senior Place Listing</h3>
                            <table class="table" style="background: var(--card-bg); margin-bottom: 1.5rem;">
                                <tr>
                                    <td><strong>Title:</strong></td>
                                    <td>${spListing.title || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Address:</strong></td>
                                    <td>${spListing.address || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>City:</strong></td>
                                    <td>${spListing.city || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>State:</strong></td>
                                    <td>${spListing.state || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>ZIP:</strong></td>
                                    <td>${spListing.zip || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Care Types (Canonical):</strong></td>
                                    <td>${spListing.care_types || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Care Types (Raw):</strong></td>
                                    <td style="color: #666; font-size: 0.9em;">${spListing.care_types_raw || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Monthly Base Price:</strong></td>
                                    <td>${spListing.monthly_base_price || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Price (High End):</strong></td>
                                    <td>${spListing.price_high_end || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Second Person Fee:</strong></td>
                                    <td>${spListing.second_person_fee || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>URL:</strong></td>
                                    <td><code style="background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.85rem;">${spListing.url}</code></td>
                                </tr>
                            </table>
                    `;
                    
                    if (wpListing) {
                        const wpTitle = wpListing.title?.rendered || 'N/A';
                        const wpId = wpListing.id || 'N/A';
                        const wpLink = wpListing.link || '#';
                        const wpSpUrl = wpListing.acf?.senior_place_url || wpListing.acf?.url || 'N/A';
                        
                        comparisonHtml += `
                            <h3 style="margin-bottom: 1rem; margin-top: 1.5rem;">WordPress Match</h3>
                            <table class="table" style="background: var(--card-bg);">
                                <tr>
                                    <td><strong>WordPress ID:</strong></td>
                                    <td>${wpId}</td>
                                </tr>
                                <tr>
                                    <td><strong>Title:</strong></td>
                                    <td>${wpTitle}</td>
                                </tr>
                                <tr>
                                    <td><strong>Senior Place URL:</strong></td>
                                    <td><code style="background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.85rem;">${wpSpUrl}</code></td>
                                </tr>
                                <tr>
                                    <td><strong>View in WordPress:</strong></td>
                                    <td><a href="${wpLink}" target="_blank">Open Listing</a></td>
                                </tr>
                            </table>
                        `;
                    } else {
                        comparisonHtml += `
                            <div style="background: #d4edda; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                <strong>‚úÖ This is a new listing!</strong> It can be imported to WordPress.
                            </div>
                        `;
                    }
                    
                    comparisonHtml += `</div>`;
                    resultDiv.innerHTML = comparisonHtml;
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${data.error || 'Failed to compare listing'}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
            }
        }

        async function fetchSingleListing() {
            const button = document.getElementById('btn-fetch-single');
            const statusDiv = document.getElementById('single-status');
            const previewDiv = document.getElementById('single-preview');
            const url = document.getElementById('single-url').value.trim();
            
            if (!url) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Please enter a Senior Place URL</div>';
                return;
            }
            
            if (!url.includes('seniorplace.com') || !url.includes('/show/')) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Invalid URL. Must be a Senior Place community URL (contains /show/)</div>';
                return;
            }
            
            button.disabled = true;
            statusDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Fetching listing...</p></div>';
            previewDiv.innerHTML = '';
            
            try {
                const response = await fetch('/api/fetch-single-listing', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const listing = data.listing;
                    statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ Listing fetched successfully!</div>';
                    
                    previewDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                            <h3>${listing.title || 'N/A'}</h3>
                            <table class="table" style="background: var(--card-bg); margin-top: 1rem;">
                                <tr>
                                    <td><strong>Address:</strong></td>
                                    <td>${listing.address || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>City:</strong></td>
                                    <td>${listing.city || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>State:</strong></td>
                                    <td>${listing.state || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>ZIP:</strong></td>
                                    <td>${listing.zip || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Care Types (Canonical):</strong></td>
                                    <td>${listing.care_types || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Care Types (Raw):</strong></td>
                                    <td style="color: #666; font-size: 0.9em;">${listing.care_types_raw || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Monthly Base Price:</strong></td>
                                    <td>${listing.monthly_base_price || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>High End:</strong></td>
                                    <td>${listing.price_high_end || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Second Person Fee:</strong></td>
                                    <td>${listing.second_person_fee || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td><strong>URL:</strong></td>
                                    <td><code style="background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.85rem;">${listing.url}</code></td>
                                </tr>
                                ${listing.featured_image ? `
                                <tr>
                                    <td><strong>Image:</strong></td>
                                    <td><a href="${listing.featured_image}" target="_blank">View Image</a></td>
                                </tr>
                                ` : ''}
                            </table>

                            ${listing.description ? `
                            <div style="margin-top: 1rem;">
                                <h4 style="margin-bottom: 0.5rem;">Description</h4>
                                <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--card-border);">${escapeHtml(listing.description)}</div>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 1.5rem;">
                                <p style="color: #666; margin-bottom: 1rem;">Ready to import? Copy the URL below and use the "Add Communities" tab with a CSV file:</p>
                                <code style="display: block; background: #f0f0f0; padding: 1rem; border-radius: 8px; word-break: break-all; font-size: 0.9rem;">
                                    ${listing.url}
                                </code>
                            </div>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${data.error || 'Failed to fetch listing'}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
            } finally {
                button.disabled = false;
            }
        }

        async function runScraper() {
            const button = document.getElementById('btn-run-scraper');
            const statusDiv = document.getElementById('scraper-status');
            const logDiv = document.getElementById('scraper-log');
            
            // Get selected states
            const states = Array.from(document.querySelectorAll('input[name="state"]:checked'))
                .map(cb => cb.value);
            
            if (states.length === 0) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Please select at least one state</div>';
                return;
            }

            button.disabled = true;
            statusDiv.innerHTML = '<div class="alert alert-info">Starting scraper...</div>';
            logDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Waiting for scraper to start...</p></div>';

            try {
                const response = await fetch('/api/run-scraper', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ states })
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ Scraper started successfully! Watch the logs below...</div>';
                    monitorProcess('scraper', 'scraper-log', button);
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${data.error}</div>`;
                    logDiv.innerHTML = '';
                    button.disabled = false;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
                logDiv.innerHTML = '';
                button.disabled = false;
            }
        }

        async function runImport() {
            const button = document.getElementById('btn-run-import');
            const statusDiv = document.getElementById('import-status');
            const logDiv = document.getElementById('import-log');
            const uploadInput = document.getElementById('import-csv-upload');
            const csvFileSelect = document.getElementById('import-csv-file').value;
            const batchSize = document.getElementById('import-batch-size').value;
            const limit = document.getElementById('import-limit').value;

            let csvFile = csvFileSelect;

            // Check if user uploaded a file
            if (uploadInput.files && uploadInput.files.length > 0) {
                button.disabled = true;
                statusDiv.innerHTML = '<div class="alert alert-info">Uploading CSV file...</div>';
                
                try {
                    const formData = new FormData();
                    formData.append('file', uploadInput.files[0]);
                    
                    const uploadResponse = await fetch('/api/upload-csv', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    
                    if (!uploadResponse.ok) {
                        statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Upload failed: ${uploadData.error}</div>`;
                        button.disabled = false;
                        return;
                    }
                    
                    csvFile = uploadData.path;
                    statusDiv.innerHTML = `<div class="alert alert-success">‚úÖ Uploaded ${uploadData.row_count} listings. Starting import...</div>`;
                } catch (error) {
                    statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Upload error: ${error.message}</div>`;
                    button.disabled = false;
                    return;
                }
            }

            if (!csvFile) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Please upload a CSV file or select one from the dropdown</div>';
                return;
            }

            button.disabled = true;
            statusDiv.innerHTML = '<div class="alert alert-info">Starting import...</div>';
            logDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Waiting for import to start...</p></div>';

            try {
                const response = await fetch('/api/run-import', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        csv_file: csvFile,
                        batch_size: parseInt(batchSize),
                        limit: limit ? parseInt(limit) : null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ Import started successfully! Watch the logs below...</div>';
                    monitorProcess('import', 'import-log', button);
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${data.error}</div>`;
                    logDiv.innerHTML = '';
                    button.disabled = false;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
                logDiv.innerHTML = '';
                button.disabled = false;
            }
        }

        async function monitorProcess(processName, logDivId, button) {
            const logDiv = document.getElementById(logDivId);
            let lastLogContent = '';

            const checkStatus = async () => {
                try {
                    const response = await fetch(`/api/process-status/${processName}`);
                    const data = await response.json();

                    if (data.status === 'running') {
                        // Fetch log
                        const logResponse = await fetch(`/api/logs/${data.log_file}`);
                        const logData = await logResponse.json();
                        
                        if (logData.content !== lastLogContent) {
                            lastLogContent = logData.content;
                            // Display logs in descending order (newest first, oldest last)
                            const lines = (logData.content || '').split(/\r?\n/).filter(line => line.trim());
                            const orderedLog = lines.reverse().join('\n');
                            // Check if we already have the stop button
                            const existingButton = logDiv.querySelector('button.button-danger');
                            if (!existingButton) {
                                logDiv.innerHTML = `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 1rem;">
                                        <h3 style="margin: 0; flex-grow: 1;">üìä Live Log - Process Running...</h3>
                                        <button class="button button-danger" style="width: auto; padding: 0.75rem 1.5rem; flex-shrink: 0;" onclick="stopProcess('${processName}', '${logDivId}')">
                                            ‚èπÔ∏è STOP
                                        </button>
                                    </div>
                                    <div class="log-viewer" id="log-content-${processName}" style="max-height: 600px; white-space: pre-wrap; overflow-y: auto;">${escapeHtml(orderedLog)}</div>
                                `;
                            } else {
                                // Just update the log content
                                const logContent = logDiv.querySelector(`#log-content-${processName}`);
                                if (logContent) {
                                    logContent.textContent = orderedLog;
                                }
                            }
                            // Scroll to top to show newest entries (logs are in descending order)
                            const viewer = logDiv.querySelector('.log-viewer');
                            if (viewer) viewer.scrollTop = 0;
                        }

                        // Check again in 2 seconds
                        setTimeout(checkStatus, 2000);
                    } else {
                        // Process finished
                        button.disabled = false;
                        
                        // Fetch final log
                        const logResponse = await fetch(`/api/logs/${data.log_file}`);
                        const logData = await logResponse.json();
                        // Display logs in descending order (newest first, oldest last)
                        const lines = (logData.content || '').split(/\r?\n/).filter(line => line.trim());
                        const orderedLog = lines.reverse().join('\n');
                        
                        logDiv.innerHTML = `
                            <div class="alert ${data.status === 'completed' ? 'alert-success' : 'alert-danger'}">
                                ${data.status === 'completed' ? '‚úÖ Process completed successfully!' : '‚ùå Process failed or was stopped!'}
                            </div>
                            <h3>Full Log (newest first):</h3>
                            <div class="log-viewer" style="white-space: pre-wrap; max-height: 600px; overflow-y: auto;">${escapeHtml(orderedLog)}</div>
                        `;

                        // Reload status
                        setTimeout(loadStatus, 2000);
                    }
                } catch (error) {
                    console.error('Error monitoring process:', error);
                }
            };

            checkStatus();
        }

        async function stopProcess(processName, logDivId) {
            const logDiv = document.getElementById(logDivId);
            const button = logDiv.querySelector('button.button-danger');
            if (button) button.disabled = true;
            
            try {
                const response = await fetch(`/api/stop-process/${processName}`, { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    logDiv.innerHTML = `
                        <div class="alert alert-danger" style="margin-bottom: 1rem;">
                            üõë <strong>Process Stopped</strong> - User requested termination
                        </div>
                        <p style="color: #666;">The ${processName} process has been terminated.</p>
                    `;
                    
                    // Reload status after a moment
                    setTimeout(loadStatus, 1500);
                } else {
                    logDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${data.error}</div>`;
                }
            } catch (error) {
                logDiv.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function formatTimestamp(ts) {
            // Convert "20251113_120410" to "Nov 13, 2025 at 12:04 PM"
            if (!ts || ts.length < 15) return ts;
            
            const year = ts.substring(0, 4);
            const month = parseInt(ts.substring(4, 6)) - 1;
            const day = ts.substring(6, 8);
            const hour = parseInt(ts.substring(9, 11));
            const minute = ts.substring(11, 13);
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            
            return `${months[month]} ${parseInt(day)}, ${year} at ${hour12}:${minute} ${ampm}`;
        }

        async function runTest() {
            const button = document.getElementById('btn-test');
            const output = document.getElementById('test-output');

            button.disabled = true;
            output.innerHTML = '<div class="loading"><div class="spinner"></div><p>Running tests... (this takes about 30 seconds)</p></div>';

            try {
                const response = await fetch('/api/test-connection');
                const data = await response.json();
                
                // Handle error response
                if (data.error) {
                    output.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${escapeHtml(data.error)}</div>`;
                    return;
                }

                const testOutput = data.output || data.errors || 'No output received';
                const status = data.exit_code === 0 ? 'success' : 'danger';
                output.innerHTML = `
                    <div class="alert alert-${status}">
                        ${data.exit_code === 0 ? '‚úÖ All tests passed!' : '‚ùå Some tests failed'}
                    </div>
                    <h3>Test Output:</h3>
                    <div class="log-viewer">${escapeHtml(testOutput)}</div>
                    ${data.errors && data.errors.trim() ? `<h3>Errors:</h3><div class="log-viewer" style="color: #ff6b6b;">${escapeHtml(data.errors)}</div>` : ''}
                `;
            } catch (error) {
                output.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${escapeHtml(error.message)}</div>`;
            } finally {
                button.disabled = false;
            }
        }
    </script>
</body>
</html>

